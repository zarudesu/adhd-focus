# ADHD Focus - Self-Hosted Deployment

Self-host ADHD Focus on your own infrastructure using Docker Compose.

## Prerequisites

- Docker and Docker Compose
- Node.js or Python3 (for key generation)
- 2GB RAM minimum (4GB recommended)
- 10GB disk space

## Quick Start

```bash
# 1. Navigate to docker directory
cd docker

# 2. Run setup script (generates secrets and .env)
./setup.sh

# 3. Start all services
docker compose up -d

# 4. Check status
docker compose ps
```

**Access points:**
- Studio (Admin UI): http://localhost:3000
- API: http://localhost:8000
- Database: localhost:5432

## Architecture

```
                    ┌──────────────┐
                    │    Kong      │ :8000 (API Gateway)
                    └──────┬───────┘
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────┴────┐      ┌─────┴────┐     ┌──────┴─────┐
    │ PostgREST│      │  GoTrue  │     │  Realtime  │
    │  (REST)  │      │  (Auth)  │     │(WebSocket) │
    └────┬────┘      └─────┬────┘     └──────┬─────┘
         │                 │                 │
         └─────────────────┼─────────────────┘
                    ┌──────┴───────┐
                    │  PostgreSQL  │ :5432
                    └──────────────┘

    ┌──────────────┐     ┌──────────────┐
    │   Storage    │     │  Functions   │ (Edge Functions)
    └──────────────┘     └──────────────┘

    ┌──────────────┐     ┌──────────────┐
    │    Studio    │     │     Meta     │ (Postgres Meta)
    └──────────────┘     └──────────────┘
```

## Services

| Service | Port | Description |
|---------|------|-------------|
| kong | 8000 | API Gateway, routes all requests |
| db | 5432 | PostgreSQL database |
| rest | - | PostgREST, auto-generates REST API |
| auth | - | GoTrue, handles authentication |
| realtime | - | Real-time subscriptions |
| storage | - | File storage API |
| functions | - | Deno Edge Functions |
| studio | 3000 | Admin UI |
| meta | - | Postgres metadata service |

## Configuration

### Environment Variables

Edit `.env` after running setup:

```bash
# Required - auto-generated by setup.sh
POSTGRES_PASSWORD=...
JWT_SECRET=...
ANON_KEY=...
SERVICE_ROLE_KEY=...

# Optional - Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your@gmail.com
SMTP_PASS=app-password

# Optional - Integrations
TELEGRAM_BOT_TOKEN=...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
```

### Email Setup

For email verification and password reset:

**Gmail:**
1. Enable 2FA on your Google account
2. Create an App Password: https://myaccount.google.com/apppasswords
3. Set in .env:
   ```
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your@gmail.com
   SMTP_PASS=your-app-password
   ```

**Without email (development):**
```
ENABLE_EMAIL_AUTOCONFIRM=true
```

### Telegram Bot

1. Create bot with [@BotFather](https://t.me/botfather)
2. Get token and add to `.env`:
   ```
   TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
   ```
3. Set webhook after deployment:
   ```bash
   curl "https://api.telegram.org/bot<TOKEN>/setWebhook?url=<YOUR_URL>/functions/v1/telegram-webhook"
   ```

## Production Deployment

### Using a Reverse Proxy (recommended)

Example with Caddy:

```
# Caddyfile
adhd.yourdomain.com {
    reverse_proxy localhost:8000
}

studio.adhd.yourdomain.com {
    reverse_proxy localhost:3000
}
```

Update `.env`:
```
API_EXTERNAL_URL=https://adhd.yourdomain.com
SITE_URL=https://your-app-domain.com
```

### Security Checklist

- [ ] Change all default passwords
- [ ] Use HTTPS in production
- [ ] Set `DISABLE_SIGNUP=true` if not needed
- [ ] Configure firewall (only expose 80/443)
- [ ] Regular backups (see below)

## Maintenance

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f db
docker compose logs -f auth
```

### Backup Database

```bash
# Backup
docker compose exec db pg_dump -U postgres postgres > backup_$(date +%Y%m%d).sql

# Restore
cat backup_20240101.sql | docker compose exec -T db psql -U postgres postgres
```

### Update

```bash
# Pull latest images
docker compose pull

# Restart with new images
docker compose up -d
```

### Reset Everything

```bash
# Stop and remove containers + volumes
docker compose down -v

# Re-run setup
./setup.sh
docker compose up -d
```

## Troubleshooting

### Database not starting

```bash
# Check logs
docker compose logs db

# Common fix: remove volume and restart
docker compose down -v
docker compose up -d
```

### Migrations not applied

Migrations are auto-applied on first start. To re-apply:

```bash
# Stop database
docker compose stop db

# Remove volume
docker volume rm adhd-focus-network_db-data

# Start again
docker compose up -d db
```

### Auth not working

1. Check JWT_SECRET matches across services
2. Verify ANON_KEY and SERVICE_ROLE_KEY are valid
3. Check logs: `docker compose logs auth`

### Studio can't connect

1. Ensure all services are running: `docker compose ps`
2. Check meta service: `docker compose logs meta`
3. Verify POSTGRES_PASSWORD is consistent

## Mobile App Connection

In the mobile app, configure:

```
SUPABASE_URL=http://your-server:8000
SUPABASE_ANON_KEY=<your-anon-key>
```

For production with HTTPS:
```
SUPABASE_URL=https://adhd.yourdomain.com
```

## Support

- Issues: https://github.com/zarudesu/adhd-focus/issues
- Docs: See `/docs` folder
